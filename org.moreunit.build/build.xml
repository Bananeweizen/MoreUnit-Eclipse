<?xml version="1.0" encoding="UTF-8"?>
<project default="build_complete" name="MoreUnit">
	<!--
		Create this file with the following properties:
		
		workspace=...
		temp_path=...
		eclipse_path=...
		
	  -->
	<property file="moreunit.properties"/>
	
	<!--
	<property name="username" value="" />
	<property name="keyfile" value="${user.home}/.ssh/id_dsa.sf" />
	<property name="updatesite" value="${user.home}/workspaces/plugindev/org.moreunit.updatesite" />
	<property name="homepage" value="${user.home}/workspaces/web/plugin" />

	<target name="upload">
		<scp file="${updatesite}/site.xml" todir="${username},moreunit:pw@web.sourceforge.net:htdocs/org.moreunit.updatesite/" keyfile="${keyfile}" sftp="true">
		</scp>
	</target>
	
	<target name="upload homepage">
		<scp file="${homepage}/kontakt.html" todir="${username},moreunit:pw@web.sourceforge.net:htdocs/" keyfile="${keyfile}" sftp="true"></scp>
	</target>
	-->
	
	<!-- Task to merge a new release into an existing update site -->
	
	<property name="main_number" value="2"/>
	<property name="major_number" value="3"/>
	<property name="minor_number" value="0"/>
	
	<property name="version_number" value="${main_number}.${major_number}.${minor_number}"/>
	<property name="version_number_file" value="${main_number}_${major_number}_${minor_number}"/>
	
	<property name="update-site-project" value="${workspace}/org.moreunit.updatesite"/>
	
	<property name="repository_folder" value="repository"/>
	
    <target 
    	name="build_complete" 
    	depends="update_version_number, refresh, prepare_build, build_feature, unzip_feature, metadata, category, merge_build" 
    	description="full build and merge with current updatesite">
        <echo>Build new release version ${version_number}</echo>
    </target>
	
	<!--
	<property name="p2.build" value="${user.home}/Desktop/moreunit_V_${version_number_file}"/>
	-->
	<property name="p2.build" value="${temp_path}/${repository_folder}"/>
	<!--<property name="p2.repo.location" value="${workspace}/org.moreunit.updatesite"/>-->
	<property name="p2.repo.location" value="${update-site-project}"/>
    
    <target name="merge_build">
		<p2.mirror source="${p2.build}">
			<destination location="${p2.repo.location}" compressed="true" append="true"/>
			<slicingoptions includeoptional="false" />
		</p2.mirror>        
    </target>

	<target name="feature_export">
		<pde.exportFeatures destination="${temp_path}" exportSource="true" exportType="zip" features="org.moreunit" filename="moreunit_V_${version_number_file}.zip" useJARFormat="true" />
	</target>
	
	<target name="unzip_feature">
		<unzip src="${temp_path}/moreunit.build/moreunitbuild/org.moreunit-build.zip" dest="${temp_path}/moreunit_V_${version_number_file}/"/>
	</target>
	
	<target name="wait_for_feature">
		<echo>Wait for feature to be finished</echo>
		<sleep seconds="30"/>
	</target>
	
	<target name="refresh">
		<echo>Refreshing feature.xml, MANIFEST.MF, category.xml</echo>
		<eclipse.refreshLocal resource="org.moreunit.feature/feature.xml" depth="infinite"/>
		<eclipse.refreshLocal resource="org.moreunit.plugin/META-INF/MANIFEST.MF" depth="infinite"/>
		<eclipse.refreshLocal resource="org.moreunit.feature/category.xml" depth="infinite"/>
	</target>
	
	<target name="metadata">
		<exec command="${eclipse_path}/eclipse -application org.eclipse.equinox.p2.publisher.FeaturesAndBundlesPublisher -metadataRepository file:${temp_path}/${repository_folder} -artifactRepository file:${temp_path}/${repository_folder} -source ${temp_path}/moreunit_V_${version_number_file}/moreunit -compress -publishArtifacts"/>
	</target>
	
	<target name="category">
		<exec command="${eclipse_path}/eclipse -application org.eclipse.equinox.p2.publisher.CategoryPublisher -metadataRepository file:${temp_path}/${repository_folder} -categoryDefinition file:/${workspace}/org.moreunit.feature/category.xml -compress"/>
	</target>

	<target name="update_version_number">
		<echo>New version number: ${version_number}</echo>
		<echo>Update version number in feature.xml</echo>
		<replaceregexp 
			file="${workspace}/org.moreunit.feature/feature.xml" 
			match="version=&quot;[0-9]\.[0-9]\.[0-9]&quot;" 
			replace="version=&quot;${version_number}&quot;"
			byline="true"/>
		<echo>Update version number in MANIFEST.MF</echo>
		<replaceregexp 
			file="${workspace}/org.moreunit.plugin/META-INF/MANIFEST.MF" 
			match="Bundle-Version: [0-9]\.[0-9]\.[0-9]" 
			replace="Bundle-Version: ${version_number}"
			byline="true"/>
		<echo>Add version to category.xml</echo>
		<replace file="${workspace}/org.moreunit.feature/category.xml">
			<replacetoken><![CDATA[<!-- new release -->]]></replacetoken>
			<replacevalue><![CDATA[<feature url="features/org.moreunit_X.X.X.jar" id="org.moreunit" version="X.X.X">
		<category name="moreunit.org"/>
	</feature>
	<!-- new release -->]]></replacevalue>
		</replace>
		<replace 
			file="${workspace}/org.moreunit.feature/category.xml"
			token="X.X.X" 
			value="${version_number}"/>
	</target>
	
	<!--
		http://help.eclipse.org/help33/index.jsp?topic=/org.eclipse.pde.doc.user/guide/tasks/pde_feature_build.htm
			
		java -jar /Applications/eclipse36Rcp/plugins/org.eclipse.equinox.launcher_1.1.0.v20100507.jar -application org.eclipse.ant.core.antRunner -buildfile /Applications/eclipse36Rcp/plugins/org.eclipse.pde.build_3.6.0.v20100603/scripts/build.xml -Dbuilder=/Users/vera/workspaces/plugindev/org.moreunit.pde
	-->
	
	<target name="prepare_build">
		<delete dir="${temp_path}/moreunit.build/"/>
		<mkdir dir="${temp_path}/moreunit.build/"/>
		<mkdir dir="${temp_path}/moreunit.build/features"/>
		<mkdir dir="${temp_path}/moreunit.build/plugins"/>
		<copydir dest="${temp_path}/moreunit.build/features/org.moreunit.feature/" src="${workspace}/org.moreunit.feature"/>
		<copydir dest="${temp_path}/moreunit.build/plugins/org.moreunit.plugin/" src="${workspace}/org.moreunit.plugin"/>
	</target>
	
    <target name="build_feature" description="description">
    	<!--
        <java jar="/Applications/eclipse36Rcp/plugins/org.eclipse.equinox.launcher_1.1.0.v20100507.jar" fork="true">
        	<arg value="-application org.eclipse.ant.core.antRunner -buildfile /Applications/eclipse36Rcp/plugins/org.eclipse.pde.build_3.6.0.v20100603/scripts/build.xml -Dbuilder=${user.home}/workspaces/plugindev/org.moreunit.pde"/>
    	</java>
    	-->
    	<exec command="java -jar ${eclipse_path}/plugins/org.eclipse.equinox.launcher_1.1.0.v20100507.jar -application org.eclipse.ant.core.antRunner -buildfile ${eclipse_path}/plugins/org.eclipse.pde.build_3.6.0.v20100603/scripts/build.xml -Dbuilder=${workspace}/org.moreunit.build"/>
    </target>
</project>